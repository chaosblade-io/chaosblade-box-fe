# 压测文件上传功能测试指南

## 概述

本文档描述了压测定义管理中文件上传功能的完整实现和测试方法。

## 功能特性

### 1. 文件上传API
- **接口**: `POST /UploadJmxFile`
- **功能**: 上传JMX压测脚本文件
- **支持格式**: `.jmx`, `.xml`
- **文件大小限制**: 10MB
- **参数**:
  - `file`: 上传的文件
  - `endpoint`: 压测引擎端点
  - `namespace`: 命名空间（可选，默认为default）

### 2. 前端交互特性
- ✅ 文件类型验证（只允许.jmx和.xml文件）
- ✅ 文件大小验证（限制10MB）
- ✅ 端点地址验证（上传前必须填写端点）
- ✅ 上传进度显示
- ✅ 上传成功后显示文件信息
- ✅ 文件上传后禁用URL输入框
- ✅ 支持手动输入文件URL作为备选方案

## 使用流程

### 1. 创建压测定义（脚本文件方式）

1. 访问压测数据管理页面：`/chaos/loadtest/admin`
2. 点击"新增压测定义"按钮
3. 填写基本信息：
   - 名称：输入压测定义名称
   - 引擎类型：选择JMETER、K6或LOCUST
   - 端点地址：输入压测引擎的端点地址（必填，用于文件上传）
4. 选择入口类型：选择"脚本文件"
5. 上传脚本文件：
   - 点击"选择文件"按钮
   - 选择.jmx或.xml格式的压测脚本文件
   - 系统自动验证文件类型和大小
   - 上传成功后显示文件信息
6. 点击"确定"保存

### 2. 编辑压测定义

1. 在压测定义列表中点击"编辑"按钮
2. 修改相应字段
3. 如果需要更换脚本文件：
   - 确保端点地址已填写
   - 重新上传新的脚本文件
   - 新文件会覆盖原有的contentRef
4. 保存更改

### 3. 文件上传验证规则

#### 前端验证
- **端点地址检查**: 上传前必须填写端点地址
- **文件类型检查**: 只允许.jmx和.xml文件
- **文件大小检查**: 文件大小不能超过10MB

#### 后端处理
- 文件上传到压测引擎
- 返回文件访问URL
- 自动设置contentRef字段

## 测试用例

### 1. 正常上传测试

**测试步骤**:
1. 创建新的压测定义
2. 填写名称、引擎类型、端点地址
3. 选择"脚本文件"入口类型
4. 上传有效的.jmx文件（小于10MB）

**预期结果**:
- 文件上传成功
- 显示文件名和大小
- URL输入框被禁用
- 保存后contentRef字段包含文件访问URL

### 2. 文件类型验证测试

**测试步骤**:
1. 尝试上传非.jmx/.xml文件（如.txt、.pdf等）

**预期结果**:
- 显示错误提示："只允许JMX和XML文件"
- 文件不会被上传

### 3. 文件大小验证测试

**测试步骤**:
1. 尝试上传超过10MB的文件

**预期结果**:
- 显示错误提示："文件大小不能超过10MB"
- 文件不会被上传

### 4. 端点地址验证测试

**测试步骤**:
1. 不填写端点地址
2. 尝试上传文件

**预期结果**:
- 显示错误提示："请先输入端点地址"
- 文件不会被上传

### 5. 网络错误处理测试

**测试步骤**:
1. 断开网络连接或使用无效的端点地址
2. 尝试上传文件

**预期结果**:
- 显示错误提示："文件上传失败"
- 上传状态重置

## API响应格式

### 成功响应
```json
{
  "success": true,
  "Data": {
    "fileName": "test_20231201_123456.jmx",
    "originalFileName": "test.jmx",
    "fileType": "application/xml",
    "fileSize": 2048,
    "uploadPath": "/uploads/jmx/test_20231201_123456.jmx",
    "accessUrl": "http://engine.example.com/files/test_20231201_123456.jmx",
    "uploadTime": 1701417600000,
    "uploadDate": "2023-12-01T12:00:00+08:00"
  }
}
```

### 错误响应
```json
{
  "success": false,
  "message": "文件上传失败：文件格式不支持"
}
```

## 故障排除

### 1. 文件上传失败
- 检查网络连接
- 确认端点地址是否正确
- 验证文件格式和大小
- 检查压测引擎服务状态

### 2. 文件显示异常
- 刷新页面重试
- 检查浏览器控制台错误信息
- 确认API响应格式正确

### 3. 保存失败
- 检查所有必填字段是否已填写
- 确认文件上传成功
- 查看网络请求日志

## 技术实现细节

### 1. 文件上传流程
1. 前端验证（文件类型、大小、端点地址）
2. 创建FormData对象
3. 调用uploadJmxFile API
4. 处理响应并更新UI状态
5. 在保存时使用返回的accessUrl

### 2. 状态管理
- `uploadedFile`: 存储上传成功的文件信息
- `uploading`: 控制上传进度显示
- `editUploadedFile`: 编辑模式下的文件信息
- `editUploading`: 编辑模式下的上传状态

### 3. 用户体验优化
- 上传过程中显示加载状态
- 上传成功后显示文件信息卡片
- 文件上传后自动禁用URL输入
- 提供清晰的错误提示信息

## 扩展功能建议

1. **文件预览**: 支持在线预览JMX文件内容
2. **文件管理**: 提供文件删除和替换功能
3. **批量上传**: 支持同时上传多个脚本文件
4. **文件版本**: 支持文件版本管理和回滚
5. **文件模板**: 提供常用的JMX模板下载
